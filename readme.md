# 什么是辅助电源？  
在电源设计中，除了主要功率电源，还需要与之隔离的电源为控制器、电压电流检测模块、驱动等各类模块进行供电。主电路电压可达几十甚至上百伏，但是一般IC供电电压为3.3V甚至更低，主电路电源无法直接进行供电。此外，由于主电路电压波动较大，而像处理器和ADC等精密器件对输入电压的稳定性有较高要求，需辅助电源为其提供稳定电压。
# 辅助电路设计需求
* ## 输入电压
    输入电压选择为10~15V，涵盖3s锂电池电压范围和驱动开关范围
* ## 输出电压
    输出电压3.3V，满足大部分处理器供电电压
* ## 最大输出电流
  处理器型号尚未确定，但目前笔者用过的高性能微控制器STM32H7系列在极限性能400MHz下，其输入电流也在100mA左右，考虑拓展性和其他IC供电以及裕量，输出电流为300mA
* ## 纹波
  越小越好
* ## 效率
  越高越好，辅助电源负载较轻，在低负载位置效率敏感
* ## 价格
  鉴于笔者尚未熟悉报销流程和电源设计流程，该项目需要试错，尽量压低成本
# 电源方案
采用buck降压电路，将输入电压降至5V再通过线性稳压电源降至3.3V。开关电源采用开关器件，通过高频开关降低输出电压；而线性稳压电源则是利用三极管的线性工作区，通过改变三极管的等效电阻实现对输出电压的稳定。
![BUCK电路拓扑](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/cabb8d8cbc27ca56e23e43f0d7712ef3.jpg)
当开关S导通时，二极管反偏，电流通过电感L向负载供电；当开关S断开时，电感L续流，二极管导通产生续流回路，继续向负载供电。
![LDO电路拓扑](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/Screenshot%202024-04-29%20152309.png)
图中为NMOS LDO（low-dropout regulator），当输出电压偏低时，放大器反向端输入引脚电压降低，导致放大器输出增大，从而导致开关管$`V_{GS}`$增大，使得开关管等效电阻减小，最终导致输出电压的升高，实现了一个电压串联负反馈。当$`V_{GS}`$不断增加直至开关管饱和时，其等效电阻达到最小，但在开关管上仍存在压降，这便导致了***dropout***。此外，当输入电压降低时，$`V_{GS}`$随之降低，从而导致压降增大，可通过增加偏置电源$`V_{BIAS}`$解决上述问题。

通过上述对buck电路和线性稳压电路分析可以看出，buck电路通过开关器件降低电压，而线性稳压器则通过在开关管上消耗掉多余功率实现降压，这直接导致了两种电路的特点。buck电路效率较高，高速开关频率使得体积减小，变换范围大，但缺点就是输出噪声大，会有电磁干扰；而线性稳压器效率较低，这也导致其发热严重，为了散热需增大其体积甚至需要增加散热片，但是其输出稳定，噪声较小，且对于动态响应较好。

根据两种电源的特点采用相互配合的方式，通过buck电路将主电路12V电压降至5V，保证电源转换效率的同时降低电压等级，再通过线性稳压器件将5V电压转换至3.3V。根据LDO能量损耗公式(1)和(2)，可以看出LDO上的损耗与输入电压和输出电压有很大关系，在相同输出电流下，输入输出电压差值越大，LOD功耗就越高。式(1)中的$`I_{ground}`$很小，在带负载的情况下可以忽略不记。LDO的功耗越高，为了能够正常工作就需要更小的热阻来维持合适的工作温度，从而增大器件尺寸，降低系统集成度和效率。buck电路直接降压至3.3V会导致输出纹波较大，对于输入电源有较高要求的精密器件难以承受，增加滤波电路的设计难度。
$$P_D=[(V_{IN}-V_{OUT})\cdot{}I_{OUT}]+(V_{IN}\cdot{}I_{ground}) \tag{1}$$
$$T_J=T_A+(R_{\theta JA}\cdot{}P_D) \tag{2}$$
# 电源参数设计
* ## BUCK电路
  考虑到日后利用分立式元件搭建buck电路，在辅助电源中buck电路尽可能采用模块化、高集成度的设计；输入电压为10~15V，输出电压为5V；为了增加拓展性，buck电路输出电流考虑为2A；价格在1\~2元
  在挑选器件过程中发现降压模块种类繁多，有集成开关管的还有外接开关管的，有隔离的还有非隔离的，同步的异步的，ECO和FCCM的等等。
  * 其中外接开关管的多适用于大功率场合，且集成度不高；
  * 隔离式电源拓扑有正激、反激等拓扑，非隔离型有buck、buck-boost等，隔离型电源成本高，结构复杂，效率低，而非隔离性则有高集成度，成本低的特点；
  * 同步整流则是将图中二极管替换为开关管，同步整流大大降低了损耗的同时提升了成本，此外在轻载情况下，异步整流无法提供电流逆向路径导致断流，而同步则避免了这种情况；
  ![异步](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/%E5%9B%BE1%EF%BC%9A%E5%BC%82%E6%AD%A5%E6%95%B4%E6%B5%81%E5%8E%9F%E7%90%86%E5%9B%BE.jpg)
  ![同步](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/%E5%9B%BE2%EF%BC%9A%E5%90%8C%E6%AD%A5%E6%95%B4%E6%B5%81%E5%8E%9F%E7%90%86%E5%9B%BE.jpg)
  ![轻载](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/%E5%9B%BE4%EF%BC%9A%E5%90%8C%E6%AD%A5%E6%95%B4%E6%B5%81%E5%BC%82%E6%AD%A5%E6%95%B4%E6%B5%81%E5%9C%A8%E8%BD%BB%E8%BD%BD%E5%B7%A5%E4%BD%9C%E6%97%B6%E7%9A%84%E7%8A%B6%E6%80%81.jpg)
  * FCCM为force continues conducting mode，其于ECO模式主要区别在轻载模式下。当开关电源工作在轻载模式下时电流效率降低，如图所示。ECO模式可以在轻载模式下降低开关频率，从而达到提高电源效率的目的，但是此时输出电压纹波增大；FCCM模式则是固定开关频率，使得输出纹波减小但是效率降低
  ![ECO效率](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/pastedimage1670383795123v1.png)
  ![FCCM效率](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/pastedimage1670383866684v2.png)
  ![ECO轻载](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/pastedimage1670384180420v3.png)
  ![FCCM轻载](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/pastedimage1670384205861v4.png-640x480.png)
  * 控制方法还有D-CAP和D-CAP2以及ACM/AECM

  在ti官网进行筛选比对，最终选择了TPS562202芯片。该芯片输入电压再4.3\~17V，输出电压再0.804\~7V，集成开关管，输出电流最大可达2A，有ECO模式，同步整流，D-CAP2控制、开关频率在580kHz，其封装为DRL(6)，尺寸仅为1.6\*1.6mm。
  该芯片的主要特性在其数据手册8.3章节有详细描述。其中对于ECO模式的启动电流是根据电感电流是否过零判断，当电感电流经过零点时，下开关管关断，电感保持断流状态，此时上开关管导通时间不变，下管关断时间增加从而达到开关频率降低的目的，ECO模式负载电流计算公式如式3：
$$I_{OUT(LL)}=\frac{1}{2Lf_{SW}}\frac{(V_{IN}-V_{OUT})\cdot{}V_{OUT}}{V_{IN}}  \tag{3}$$
  在此对上述公式做出解释：考虑电流连续工作模式临界点即电流最小值为0，假设输出电压稳定为$`V_{OUT}`$，则电流增长率为$`\frac{V_{IN}-V_{OUT}}{L}`$，电源周期为开关频率的倒数，占空比为$`\frac{V_{OUT}}{V_{IN}}`$，则上管导通时间为$`\frac{V_{OUT}}{f_{SW}V_{IN}}`$，乘以电流上升率并求其平均值可得式3。
  数据手册推荐设计电路图：
![推荐设计电路图](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/Screenshot%202024-05-01%20135726.png)

  其中重要参数设计如下：
  * 输出分压电阻，芯片内部参考电压为0.804V，输出电压经过电阻分压后反馈至参考电压，当下电阻10kΩ时，上电阻选择52.19kΩ，采用最接近的1%标准电阻52.3kΩ。
  > 此时电阻选择既不能过大也不能过小，若电阻选择过小则会导致电阻之路电流较大，在其上产生损耗；而电阻过大则会导致电阻电流较小，容易受外界噪声干扰，并且芯片输入端电流无法忽略
  * 输出滤波电路设计，该滤波电路设计不仅考虑了芯片开关频率，还主要考虑了芯片内部D-CAP2控制方法所产生的零点，在此选择数据手册中的推荐值：电感4.7uH，电容44uF
  * 电感电流纹波计算如式4，与式3推导过程相同不再赘述，通过计算在理想满载状况下输出电感电流纹波峰峰值为1.15A，电流最大值峰值2.575A，电流有效值2.027A（该结果计算于开关频率540kHz，根据图示在12V输入5V输出情况下开关频率在540kHz附近），在普通断流模式下电感电流纹波减小，但是由于ECO模式导通时间不变，所以电感电流波动峰值不变。
  $$I_{P-P}=\frac{V_{OUT}}{V_{IN}}\cdot{}\frac{V_{IN}-V_{OUT}}{L_O\cdot{}f_{SW}} \tag{4}$$
  输出电压纹波计算可通过对电感纹波电流积分计算出电容两端电荷量变化，再通过电荷量变化计算电容两端电压变化，计算如下所示：
  $$\Delta Q=\frac{I_{P-P}}{8f_{SW}} \tag{5}$$
  $$V_{P-P}=\frac{2\Delta Q}{C} =\frac{V_{OUT}(V_{IN}-V_{OUT})}{4V_{IN}L_Of_{SW}^2C} \tag{6}$$
  计算可得输出电压峰峰值在0.0121V，频率为开关频率540kHz。在轻载ECO模式下，电感纹波不变，负载电流却减小，这将导致涌入电容电荷增多，从而导致输出电压波动增加，当输出空载时最大波动为连续模式的四倍。
  > 上述对输出波动分析建立在理想器件情况下，实际情况下电感与电容均有等效电阻存在，应选择尽量理想器件。滤波电容可选择等效电阻较低的陶瓷电容，并且在输出通过并联电容的方式达到在增加电容容量的同时降低等效电阻。此外，在存在直流偏置的情况下电容容值也会有所下降，此部分将在LDO设计时进行描述。
  * 输入滤波电容设计，滤波电容主要是用来与前级电路解耦，减小输入电压纹波。此处数据手册建议使用10uF与0.1uF并联达到较好的滤波效果。
  > 实际电容存在等效电阻与等效电感，等效电感与电容形成谐振，较大的电容具有较低的谐振频率，对于高频信号表现为感性；而较小的电容谐振频率较高，但是其容值较小，截至频率较高，对于中低频抑制性能不如大电容。因此大小电容并联可使得滤波电路兼具低频和高频的良好滤波性能。
  * *BootStrap*电容选取0.1uF，BST引脚为上开关管输入引脚，用于自举驱动开关管。
  * $C_{FF}$为前馈电容，输出高频噪声通过该电容形成较小阻抗回路，使得输出高频噪声增益降为1，从而减小输出噪声。此外该电容还可使该系统引入零点，增加系统相位裕度，提高系统稳定性。再次选择推荐值22pF，具体设计可参考[德州仪器手册](https://www.ti.com/lit/an/sbva042/sbva042.pdf?ts=1714551248183)

* ## LDO电路
  LDO输入电压为5V，输出电压为3.3V，考虑裕量选取输出电流300mA，价格在1元以内。
  本篇LDO学习主要基于[德州仪器文档](https://www.ti.com/seclit/eb/slyy151a/slyy151a.pdf?ts=1714636153499&ref_url=https%253A%252F%252Flogin.ti.com%252F)，该文档并未对LDO开关器件即控制方法进行详细介绍，主要介绍LDO参数以及提高这些参数的方法。
  * 压降。压降指的输入与输出之间的电压差最小值，主要是由于LDO中导通开关管等效电阻产生，当输入电压接近输出电压时，开关管接近饱和，电阻减小。当开关管完全饱和时，此时输入电压与输出电压差值最小，该电压称为压降。当开关管饱和程度越深，等效电阻越小压降越小；当输出电流越大，电流在开关管等效电阻上的电压降落越大；开关器件体积越大，等效电阻越小，压降越小。
  * 热效应。根据式(1)与式(2),可以计算出不同输入电压和输出电流情况下对应的器件温升，若器件温升超过其能承受范围便会有过热保护进行关断，待器件冷却后再次恢复工作。在此手册中给出三种用于减少期间上热损耗的方法：
    * 通过增加器件接地面积提高散热效率。部分芯片有散热焊盘，通过增加输入输出的铺铜面积和散热焊盘的铺铜面积可减小热阻，有利于热量散出从而降低器件温度。
    * 通过增加散热鳍片。有的较大功率的器件会在封装上加装散热器，可通过螺丝将散热鳍片安装至器件表面，增加散热效率
    * 与LDO串联电阻来转移热量。通过输入串联电阻可将原本产生于LDO上的热量转移至电阻，将LDO工作在接近饱和区域。但是电阻选择需要注意，选择电阻过大将导致即使LDO工作于饱和区，在输入电阻上产生的压降也无法达到输出要求。
  * 静态电流是指器件在轻载或空载状态下所需要的电流，其值通常在uA级别，当LDO正常工作时可忽略不计，但当LDO工作于轻载状态时较大的静态电流将导致效率降低，对功率敏感的场景如移动设备，需考虑低静态电流器件。
  * 电流限制主要有两种限制方式，第一种为*brick-wall*模式，在该模式下，当电流上升至限定阈值时电流无法继续上升，被限制在阈值附近，就像有一堵墙阻挡电流继续上升一样。第二种模式为*foldback*模式，在该模式下，当电流上升至阈值时便无法上升，但是若输出负载阻值很小甚至短路时，其将导致输出电压的降低，在这种情况下，输出电流的阈值也会随着输出电压的下降而减小。在*brick-wall*模式下，当负载阻值很小时其限制电流在阈值附近，但是电流在开关管上产生热量导致开关管温度升高，开关管的等效电阻也随之增加，此时即使在电流没有继续增大的情况下，导致压降增大。若继续保持输出电流不变将导致开关管温度进一步升高，有造成过热的风险，而*foldback*模式则通过变化的电流阈值规避了这一风险，增加了器件的工作稳定性。
  * PSRR(Power-supply rejection ratio)输入电源抑制比，用于描述器件输出对于输入纹波的抑制性能，计算公式如(7)所示:
  $$PSRR(dB)=20log\frac{V_{ripple(in)}}{V_{ripple(out)}} \tag{7}$$
  通常PSRR与频率相关构成曲线，与输出电流成反比。输出滤波电容、前馈电容和噪声抑制电容对PSRR有增强效果，但是对于高频抑制效果主要依赖PCB布局。
  * 噪声。不同器件噪声水平不同，器件噪声主要来源于器件内部参考电压，若芯片存在NR引脚便可在其上通过电容接地，用于降低参考电压的噪声水平。此外噪声可能还来源于内部运算放大器，开关器件等。还可增加前馈电容来降低器件输出噪声，通过增加前馈电容可使得输出噪声在反馈之路上形成低阻抗回路，降低增益，此处前馈电容与buck电路类似；此外前馈电容还可给系统增加零点提高系统的相位裕度，增加系统稳定性。
  > 此外，该手册还介绍了在存在直流偏置的情况下，电容电介质可能出现***极化锁定***现象，这将导致电容容值下降，如图所示。此外电容容值还会受温度影响，不同型号影响如图。
![电容极化变化](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/Screenshot%202024-04-29%20171019.png)
![电容温度变化](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/Screenshot%202024-05-03%20194242.png)
  经过选择最终使用了德州仪器TLV740P型号LDO，输入电压为1.4\~5.5V，输出电压固定3.3V，最大输出电流为300mA，静态电流50uA。选择DQN封装，尺寸仅为1mm\*1mm，热阻为224.3℃/W，当输出电流达到300mA时，压差为5.5-3.3=1.7V，LDO功率为0.51W，其结温升可达114.4℃，在室温情况下略微超过最大运行结温，若LDO工作于建议温度下则输出电流最大157mA。(此处设计存在缺陷，但限于器材已经选购且满足普通为控制器需求便暂且搁置)

  [数据手册](https://www.ti.com/lit/ds/symlink/tlv740p.pdf?ts=1714689053248&ref_url=https%253A%252F%252Fwww.ti.com%252Fproduct%252FTLV740P)中提到另一个特性引起笔者兴趣，当LDO在软起动过程中，$`V_{IN}`$倾斜线性上升，$`V_{IN}`$开始时刻由于未达到***UVLO***(undervoltage lockout)的上升阈值，$`V_{OUT}`$没有输出；当$`V_{IN}`$达到上升阈值后，LDO进入dropout模式，输出随着输入电压增大，开关管饱和；但是当$`V_{OUT}`$上升超过期望输出电压后并未立即停止，继续上升一段时间后回落至期望输出电压产生过冲，如图所示。该现象产生原因主要是开关器件GS极之间存在电容，在dropout模式下开关管饱和，当输出电压超过期望值后，GS电容两端仍残存电压，开关管仍在低阻值状态，从而导致过冲，其原理如图所示：
![过冲示意图](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/Screenshot%202024-05-05%20200957.png)
![过冲暂态过程原理](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/Screenshot%202024-05-05%20201027.png)

该器件原理图简单，使用推荐值即可。

# PCB设计
笔者在此使用嘉立创EDA进行原理图绘制和PCB设计，并直接在商城购买材料与PCB生产。原理图绘制简单，如下图：
![电路原理图](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/Screenshot%202024-05-05%20202318.png)
PCB设计过程中有以下注意事项：
* 功率回路需要尽可能的宽以降低阻抗和增加散热，在此笔者选择进行部分面积的铺铜
* 输出输入滤波电容需要离器件尽可能的近以降低阻抗和干扰
* 使得SW引脚线尽可能宽，并且不允许经过器件底部。这是因为SW引脚会有高频电平反转，增大线宽可以降低电磁辐射，避免对器件本身造成影响
* 反馈回路与GND之间要采用开尔文连接方式。反馈引脚与地之间连接反馈回路下电阻两端电压，需要利用开尔文连接法将下电阻两端电压
> 开尔文连接是利用四根导线进行连接，通过将载流回路与测量回路区分开来来降低接触电阻、焊盘等其他电阻影响，多用于小电阻电压精密测量，例如笔者下个项目电流测量模块便可能用到该连接方法。如图所示
> ![开尔文连接](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/v2-c87fe82ca764fba70fbd134af8c2aa17_r.jpg)
* 电压反馈回路应尽量远离功率回路或高频开关回路以免造成噪声干扰，应尽量使用铺铜接地屏蔽。反馈回路还应尽可能的小，以避免噪声干扰。
* 在器件周围布置过孔以增加散热，但在器件的散热焊盘下的过孔需塞油以防止漏锡导致焊接不牢。
  
最终PCB设计如图所示：
![PCB反](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/Screenshot%202024-05-05%20211035.png)
![PCB正](https://github.com/HUSTdzc/Auxiliary-SMPS/blob/main/IMAGE/Screenshot%202024-05-05%20211052.png)
设计PCB设计过程中笔者由于追求小体积将体积较大的滤波电感单独放置于PCB一面，其余较小的元器件放置于另一端，通过外接排针引出电源。该设计极大的减小了设计面积（13.2mm/*14.7mm），但是也造成了极大的麻烦。例如SW引脚应流过高频大功率电流，经过电感滤波后输出，于是只能通过过孔将其与背面电感相连，单个过孔载流能力有限于是便采用了四个过孔进行连接，但是四个过孔的回路长度存在差异最终通流必然不会均衡；此外，笔者所购电感并不是闭合铁芯，漏磁较为严重，且电感底部铺铜将对电感感值有影响，此外电感产成的变化磁场将对背面器件造成影响；当实际PCB拿到时笔者发现其过于迷你，导致焊接十分困难，并且碍于笔者所在实验室器材并不完备，PCB的焊接过程可谓十分折磨。以后将会再版，再次设计，不再过分追求小的面积而牺牲其他性能。
